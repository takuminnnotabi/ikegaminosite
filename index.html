<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>先生に質問チャット（見た目カスタム版）</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: sans-serif; display: flex; height: 100vh; }

    /* 左側：チャットエリア全体 */
    #container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* ツールバー部分は非表示（デモには不要のため） */
    #toolbar { display: none; }

    /* チャットメッセージ領域 */
    #chatMessages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      background: #fafafa;
      border-bottom: 1px solid #ddd;
    }
    /* 吹き出し */
    .msg {
      max-width: 70%;
      margin-bottom: 12px;
      padding: 8px 12px;
      border-radius: 12px;
      word-wrap: break-word;
      line-height: 1.4;
      position: relative;
      font-size: 14px;
    }
    .msg.self {
      background: #dcf8c6;
      align-self: flex-end;
      border-top-right-radius: 2px;
    }
    .msg.other {
      background: #fff;
      align-self: flex-start;
      border-top-left-radius: 2px;
    }
    .msg .meta {
      display: block;
      font-size: 11px;
      color: #555;
      margin-bottom: 4px;
    }

    /* 入力欄 */
    #chatInput {
      display: flex;
      padding: 8px;
      background: #fff;
      border-top: 1px solid #ccc;
    }
    #chatInput input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    #chatInput button {
      width: 60px;
      margin-left: 8px;
      background: #00aaff;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }

    /* 右側：参加者リスト */
    #sidebar {
      width: 240px;
      border-left: 1px solid #ddd;
      background: #f9f9f9;
      padding: 16px;
      overflow-y: auto;
    }
    #sidebar h2 {
      font-size: 16px;
      margin-bottom: 8px;
    }
    #participants {
      list-style: none;
    }
    #participants li {
      padding: 6px 0;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }

    /* レイアウト：PCは横並び、スマホは縦積み */
    @media (max-width: 699px) {
      body { flex-direction: column; }
      #sidebar { width: 100%; border-left: none; border-top: 1px solid #ddd; }
    }
  </style>
</head>
<body>

  <!-- チャット＋入力エリア -->
  <div id="container">
    <div id="chatMessages"></div>
    <div id="chatInput">
      <input id="chatText" placeholder="メッセージを入力…" disabled />
      <button id="sendBtn" disabled>送信</button>
    </div>
  </div>

  <!-- 参加者リスト -->
  <div id="sidebar">
    <h2>参加者</h2>
    <ul id="participants"></ul>
  </div>

  <!-- Gun.js -->
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script>
    const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);

    let roomName, userName, userId;
    let usersRef, messagesRef;
    const shown = new Set();

    const chatArea = document.getElementById('chatMessages');
    const input    = document.getElementById('chatText');
    const sendBtn  = document.getElementById('sendBtn');
    const partList = document.getElementById('participants');

    // 最初にルーム名とユーザー名を取得
    roomName = prompt('部屋名を入力してください：');
    if (!roomName) alert('部屋名が必要です');
    userName = prompt('ユーザー名を入力してください：');
    if (!userName) alert('ユーザー名が必要です');
    userId = Date.now() + Math.random().toString(36).slice(2);

    // Gun.js の参照を作成
    const roomRef = gun.get('rooms').get(roomName);
    usersRef    = roomRef.get('users');
    messagesRef = roomRef.get('messages');

    // UI 有効化
    input.disabled   = false;
    sendBtn.disabled = false;

    // 参加者登録
    usersRef.get(userId).put(userName);
    usersRef.map().on((name, id) => {
      // 追加・削除を反映
      const existing = document.getElementById('u-' + id);
      if (name) {
        if (!existing) {
          const li = document.createElement('li');
          li.id = 'u-' + id;
          li.textContent = name;
          partList.appendChild(li);
        }
      } else {
        if (existing) existing.remove();
      }
    });

    // メッセージ受信
    messagesRef.map().on((msg, id) => {
      if (!msg || shown.has(id)) return;
      shown.add(id);
      const div = document.createElement('div');
      div.className = 'msg ' + (msg.name === userName ? 'self' : 'other');
      div.innerHTML = `<span class="meta">${msg.name} ${new Date(msg.timestamp).toLocaleTimeString()}</span>${msg.text}`;
      chatArea.appendChild(div);
      chatArea.scrollTop = chatArea.scrollHeight;
    });

    // 送信
    function send() {
      const txt = input.value.trim();
      if (!txt) return;
      messagesRef.set({ name: userName, text: txt, timestamp: Date.now() });
      input.value = '';
    }
    sendBtn.onclick = send;
    input.addEventListener('keypress', e => {
      if (e.key === 'Enter') send();
    });

    // 退出時に参加者削除
    window.addEventListener('beforeunload', () => {
      usersRef.get(userId).put(null);
    });
  </script>
</body>
</html>

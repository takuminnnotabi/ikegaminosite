<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ドキュメント＋質問＋チャットデモ</title>
  <style>
    body { margin: 0; font-family: sans-serif; display: flex; height: 100vh; }
    #container { flex: 1; display: flex; flex-direction: column; }
    #toolbar { background: #f0f0f0; padding: 8px; border-bottom: 1px solid #ccc; }
    #toolbar input, #toolbar button { margin-right: 8px; }
    #doc { flex: 1; padding: 16px; overflow: auto; outline: none; }
    #doc span[data-qid] { background-color: #ffeb3b; cursor: pointer; }
    #sidebar { width: 320px; border-left: 1px solid #ddd; padding: 16px; box-sizing: border-box; overflow: auto; background: #fafafa; }
    #sidebar h2 { margin-top: 0; font-size: 18px; }
    #sidebar .question { margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
    #chatMessages { height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 8px; background: #fff; }
    #chatInput { margin-top: 8px; }
    #chatInput input { width: calc(100% - 60px); padding: 4px; }
    #chatInput button { width: 50px; }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script>
    // --- ここにあなたの Firebase 設定を貼り付けてください ---
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>
</head>
<body>
  <div id="container">
    <div id="toolbar">
      <input id="roomIdInput" type="text" placeholder="ルームIDを入力" />
      <button id="joinBtn">参加</button>
      <button id="askBtn">先生に質問する</button>
    </div>
    <div id="doc" contenteditable="true">
      <h1>ここにドキュメント本文を書いてください</h1>
      <p>テキストを選択して「先生に質問する」ボタンを押すと、質問を挿入できます。</p>
    </div>
  </div>

  <div id="sidebar">
    <h2>質問一覧</h2>
    <div id="questions"></div>

    <h2>チャット</h2>
    <div id="chatMessages"></div>
    <div id="chatInput">
      <input id="chatText" placeholder="メッセージを入力" disabled />
      <button id="sendBtn" disabled>送信</button>
    </div>
  </div>

  <script>
    // 質問機能
    const questions = [];
    function updateSidebar() {
      const qContainer = document.getElementById('questions');
      qContainer.innerHTML = '';
      questions.forEach(q => {
        const div = document.createElement('div');
        div.classList.add('question');
        div.innerHTML = `<strong>Q${q.id}：</strong> ${q.text}<br><em>（"${q.selection}" を参照）</em>`;
        qContainer.appendChild(div);
      });
    }
    function askQuestion() {
      const sel = window.getSelection();
      if (!sel.rangeCount || !sel.toString().trim()) {
        return alert('まず本文中のテキストを選択してください。');
      }
      const questionText = prompt('先生への質問を入力してください：');
      if (!questionText) return;
      const range = sel.getRangeAt(0);
      const span = document.createElement('span');
      const qid = questions.length + 1;
      span.setAttribute('data-qid', qid);
      span.title = `質問 Q${qid}`;
      range.surroundContents(span);
      questions.push({ id: qid, text: questionText, selection: sel.toString() });
      sel.removeAllRanges();
      updateSidebar();
    }
    document.getElementById('askBtn').addEventListener('click', askQuestion);
    document.getElementById('doc').addEventListener('click', e => {
      if (e.target.tagName === 'SPAN' && e.target.dataset.qid) {
        const idx = e.target.dataset.qid;
        const qEl = document.querySelector(`#questions .question:nth-child(${idx})`);
        if (qEl) {
          qEl.scrollIntoView({ behavior: 'smooth' });
          qEl.style.background = '#ffeeba';
          setTimeout(() => qEl.style.background = '', 1000);
        }
      }
    });

    // チャット機能
    let roomId = null, username = null;
    const joinBtn  = document.getElementById('joinBtn');
    const roomInput= document.getElementById('roomIdInput');
    const sendBtn  = document.getElementById('sendBtn');
    const chatText = document.getElementById('chatText');
    const chatArea = document.getElementById('chatMessages');

    joinBtn.addEventListener('click', () => {
      const rid = roomInput.value.trim();
      if (!rid) return alert('ルームIDを入力してください。');
      const name = prompt('ユーザー名を入力してください：');
      if (!name) return alert('ユーザー名が必要です。');
      roomId = rid; username = name;
      roomInput.disabled = true;
      joinBtn.disabled  = true;
      chatText.disabled = false;
      sendBtn.disabled  = false;

      // リアルタイムにメッセージ受信
      const chatRef = db.ref('rooms/' + roomId);
      chatRef.off();  // 重複リスン防止
      chatRef.on('child_added', snap => {
        const msg = snap.val();
        const div = document.createElement('div');
        div.textContent = msg.user + ': ' + msg.text;
        chatArea.appendChild(div);
        chatArea.scrollTop = chatArea.scrollHeight;
      });
    });

    sendBtn.addEventListener('click', () => {
      const text = chatText.value.trim();
      if (!text) return;
      db.ref('rooms/' + roomId).push({
        user: username,
        text: text,
        timestamp: Date.now()
      });
      chatText.value = '';
    });
  </script>
</body>
</html>
